<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" , charset="UTF-8">
  <title>RegAn</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¦‹</text></svg>">
  <style>
    img {
      display: grid;
      margin: auto;
      width: 92%;
      filter: opacity(20%) blur(8px);
    }

    figcaption {
      width: 50%;
      float: left;
      margin: auto;
    }

    body {
      color: white;
      background-color: #282827;
    }

    .center_btn {
      display: grid;
      width: 300px;
      margin: auto;
    }

    .topRight {
      position: absolute;
      top: 0%;
      right: 2%;
    }
  </style>
</head>

<body onload="loadInitialMatch()">

  <h2>Regression Annotation Tool</h2>
  <p>Welcome. Please click on the image which looks better.<br>Hotkeys: 'X' left image, 'M' right image, 'B' equal</p>
  <div class="topRight">
    <p>Author: Matthias MÃ¶ller<br>License: <a href="https://www.gnu.org/licenses/agpl-3.0.en.html">AGPL-3.0</a><br><a href="https://github.com/TinyTinni/RegAn">Visit on GitHub</a></p>
  </div>


  <div class="center_btn">
    <button class="center_btn" id="btn_draw" , disabled>Equal</button>
    <div><br></div>
  </div>

  <figcaption>
    <img src="" id="left_image" data-id onload="fadeIn('left_image')">
  </figcaption>
  <figcaption>
    <img src="" id="right_image" data-id onload="fadeIn('right_image')">
  </figcaption>


  <script language="javascript">

    function fadeOut(img) {
      img.style.filter = "opacity(20%) blur(8px)"
      img.style.transition = "4s";
      img.removeEventListener("click", onPlayerClicked)
    }

    function fadeIn(img_str) {
      img = document.getElementById(img_str)
      img.style.filter = "opacity(100%) blur(0px)"
      img.style.transition = "0.75s";

      // if both images are loaded, make them clickable
      left_image = document.getElementById("left_image")
      right_image = document.getElementById("right_image")
      if (left_image.complete && right_image.complete) {
        left_image.addEventListener("click", onPlayerClicked)
        right_image.addEventListener("click", onPlayerClicked)
        btn = document.getElementById("btn_draw")
        btn.removeAttribute("disabled")
        btn.addEventListener("click", onPlayerClicked)
      }
    }

    function processMatchResponse(response) {
      response.json()
        .then(function (next_match) {
          left_image = document.getElementById("left_image")
          right_image = document.getElementById("right_image")
          left_image.src = "images/" + next_match.home
          right_image.src = "images/" + next_match.guest
          left_image.dataId = next_match.home_id
          right_image.dataId = next_match.guest_id
        })
    }

    function loadInitialMatch() {
      fetch('/matches', { method: 'GET' })
        .then(processMatchResponse)
        .catch((error) => {
          window.location.reload(true)
        });
    }

    function onPlayerClicked() {
      left_image = document.getElementById("left_image")
      right_image = document.getElementById("right_image")

      // disable images, prepare for loading
      fadeOut(left_image)
      fadeOut(right_image)
      document.getElementById("btn_draw").setAttribute("disabled", true)
      document.getElementById("btn_draw").removeEventListener("click", onPlayerClicked)

      // get winner
      switch(event.currentTarget.id)
      {
        case "left_image": winner = 1
        break;
        case "right_image": winner = 0
        break;
        case "btn_draw": winner = 0.5
        break;
      }

      // prepare message
      const match = {
        home_id: left_image.dataId,
        guest_id: right_image.dataId,
        won: winner
      }

      // send message and load new match
      fetch('/matches', { method: 'POST', body: JSON.stringify(match), headers: { 'Content-Type': 'application/json' } })
        .then(processMatchResponse)
        .catch((error) => {
          window.location.reload(true)
        });
    }
    
    // add hotkeys
    document.addEventListener('keydown', function (event) {
    let click_event = new Event("click");
    if (event.key == 'x') {
      document.getElementById("left_image").dispatchEvent(click_event)
    }else if (event.key == 'm'){
      document.getElementById("left_image").dispatchEvent(click_event)
    }else if (event.key == 'b'){
      document.getElementById("btn_draw").dispatchEvent(click_event)    
    }
});

  </script>

</body>

</html>